# components_k8s

## Расчёт ресурсов и подбор worker-нод

Ниже приведён расчёт суммарных ресурсов по компонентам приложения, а также пример подбора количества worker-нод с учётом (1) запаса на отказ минимум одной ноды и (2) служебных резервов на ноде (kubelet/OS + eviction threshold).

### Входные данные

| Компонент            | Реплик | CPU на реплику (core) | RAM на реплику (GB) | Итого CPU (core) | Итого RAM (GB) |
|----------------------|:------:|----------------------:|--------------------:|-----------------:|---------------:|
| База данных (HA)     |   3    |                   1.0 |                 4.0 |              3.0 |           12.0 |
| Кеш (HA)             |   3    |                   1.0 |                 4.0 |              3.0 |           12.0 |
| Backend              |  10    |                   1.0 |                 0.6 |             10.0 |            6.0 |
| Frontend             |   5    |                   0.2 |                0.05 |              1.0 |           0.25 |
| **Итого**            | **21** |          —            |           —         |      **17.0**    |     **30.25**  |

### Суммарные requests

- CPU requests: **17 core**
- RAM requests: **30.25 GB**

### Запас на выход из строя 1 ноды (N+1)

Требование: при отказе одной ноды оставшиеся должны вместить всю нагрузку.

Условие на суммарную полезную ёмкость кластера:
\[
C_{total} \ge W \cdot \frac{N}{N-1}
\]
где:
- \(W\) — суммарная нагрузка (requests),
- \(N\) — количество worker-нод,
- \(C_{total}\) — суммарная полезная ёмкость (то, что реально доступно под Pod’ы).

Эквивалентная проверка (проще на практике):
\[
(N-1)\cdot C_{node} \ge W
\]
то есть после потери одной ноды оставшиеся \((N-1)\) нод должны покрывать всю нагрузку.

### Учёт служебных ресурсов ноды

На каждой ноде часть ресурсов резервируется под системные компоненты и пороги выселения (eviction), поэтому под Pod’ы доступно меньше номинала ноды.

Для примера выбираем тип ноды **4 vCPU / 16 GB** и оцениваем доступное под Pod’ы:

- Доступный CPU под Pod’ы: примерно **3.92 core** (после резервов).
- Доступная RAM под Pod’ы: примерно **13.3 GB** (после резервов и eviction).

> Примечание: точные значения зависят от настроек kubelet (`system-reserved`, `kube-reserved`, eviction thresholds) и дистрибутива/провайдера, здесь использованы типичные допущения.

### Подбор количества нод (пример)

Пусть одна нода даёт полезную ёмкость:
- \(C_{cpu,node} = 3.92\) core  
- \(C_{ram,node} = 13.3\) GB  

Минимальное число нод **без учёта N+1** по CPU:
\[
N_{min,cpu} = \left\lceil \frac{17}{3.92} \right\rceil = 5
\]

Проверяем N+1 (потеря 1 ноды):

Для \(N = 5\):
- CPU после отказа: \((5-1)\cdot 3.92 = 15.68\) core — не хватает (нужно 17).
- RAM после отказа: \((5-1)\cdot 13.3 = 53.2\) GB — хватает.

Для \(N = 6\):
- CPU после отказа: \((6-1)\cdot 3.92 = 19.6\) core — хватает.
- RAM после отказа: \((6-1)\cdot 13.3 = 66.5\) GB — хватает.

### Итог

| Параметр                                       | Значение                      |
|-----------------------------------------------|-------------------------------|
| Суммарная нагрузка (requests)                 | **17 core CPU**, **30.25 GB RAM** |
| Выбранный тип worker-ноды                     | **4 vCPU / 16 GB RAM**        |
| Оценка полезной ёмкости 1 ноды под Pod’ы      | ~**3.92 core**, ~**13.3 GB**  |
| Количество worker-нод (с запасом N+1)         | **6**                         |
| Проверка N+1 по CPU                           | \((6-1)\cdot 3.92 = 19.6 \ge 17\) — OK |
| Проверка N+1 по RAM                           | \((6-1)\cdot 13.3 = 66.5 \ge 30.25\) — OK |

